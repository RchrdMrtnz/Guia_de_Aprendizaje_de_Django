<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura Empresarial en Django - Guía Definitiva</title>
    <meta name="description" content="Guía avanzada sobre arquitectura en Django: Patrones, Servicios, Selectores, DDD Pragmático y Escalabilidad.">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- PrismJS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <style>
        /* Custom Scrollbar for Sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* Prism overrides */
        pre[class*="language-"] {
            border-radius: 0.5rem;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased dark:bg-gray-900 dark:text-gray-100">

    <!-- Mobile Header -->
    <div class="lg:hidden flex items-center justify-between p-4 bg-gray-900 text-white sticky top-0 z-50 shadow-md">
        <span class="font-bold text-lg">Django Guía</span>
        <button id="mobile-menu-toggle" class="p-2 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>

    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="default-sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full lg:translate-x-0 bg-gray-900 border-r border-gray-800" aria-label="Sidebar">
        <div class="h-full flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <a href="index.html" class="flex items-center space-x-3 rtl:space-x-reverse">
                    <span class="self-center text-xl font-bold whitespace-nowrap text-white">Django Guía</span>
                </a>
                <p class="text-xs text-gray-500 mt-2">Dominando el framework web para perfeccionistas.</p>
            </div>

            <div class="px-3 py-4 overflow-y-auto flex-1 custom-scrollbar" id="sidebar-content">
                <!-- Javascript will inject menu here -->
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                        <div class="space-y-2">
                            <div class="h-4 bg-gray-700 rounded"></div>
                            <div class="h-4 bg-gray-700 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800">
                <a href="https://github.com/RchrdMrtnz/Guia_de_Aprendizaje_de_Django" target="_blank" class="flex items-center p-2 text-gray-400 rounded-lg hover:text-white hover:bg-gray-800 group transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="ml-3 text-sm">Ver en GitHub</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="p-4 lg:ml-64 min-h-screen">
        <div class="p-4 lg:p-8 max-w-4xl mx-auto">
            <main class="prose prose-slate prose-lg max-w-none prose-headings:text-gray-900 dark:prose-headings:text-gray-100 dark:prose-p:text-gray-300 dark:prose-strong:text-white dark:prose-li:text-gray-300 prose-a:text-blue-600 hover:prose-a:text-blue-800 prose-pre:bg-gray-800 prose-pre:shadow-lg rounded-xl">

                <h1 id="arquitectura-empresarial-en-django">Arquitectura Empresarial en Django</h1>

                <div class="bg-blue-50 dark:bg-gray-800 border-l-4 border-blue-500 p-4 mb-6">
                    <p class="text-blue-700 dark:text-blue-300 font-medium">
                        Esta guía está diseñada para líderes técnicos y arquitectos. Cubre cómo escalar Django desde un MVP hasta un sistema de nivel empresarial, enfocándose en mantenibilidad, desacoplamiento y rendimiento.
                    </p>
                </div>

                <h2 id="1-clarificacion-del-patron-mtv">1. Clarificación del patrón MTV</h2>
                <p>Django sigue el patrón <strong>Model-Template-View (MTV)</strong>, que es esencialmente una variante de MVC, pero con matices críticos que afectan la arquitectura:</p>
                <ul>
                    <li><strong>Model (Modelo):</strong> No es solo un esquema de base de datos. En Django, el modelo es un híbrido que mezcla <strong>Active Record</strong> (acceso a datos) con <strong>Domain Model</strong> (reglas de negocio básicas y validación). Esto facilita el desarrollo rápido pero acopla fuertemente la lógica de negocio a la base de datos.</li>
                    <li><strong>Template (Plantilla):</strong> Es la capa de presentación (equivalente a la "View" en MVC tradicional).</li>
                    <li><strong>View (Vista):</strong> En Django, la Vista es el <strong>Orquestador</strong> (equivalente al "Controller" en MVC). Su única responsabilidad debería ser recibir la petición HTTP, llamar a la lógica adecuada y retornar una respuesta HTTP.</li>
                </ul>
                <p><strong>El problema arquitectónico:</strong> Como Django es "baterías incluidas", incentiva poner lógica en las Vistas o en los Modelos. Al crecer, este acoplamiento natural se convierte en el mayor cuello de botella para la mantenibilidad.</p>

                <h2 id="2-fat-views-y-fat-models">2. Problema de las Fat Views y Fat Models</h2>
                <p>Dos anti-patrones dominan los proyectos legacy de Django:</p>

                <h3 id="fat-views-vistas-obesas">Fat Views (Vistas Obesas)</h3>
                <p>Ocurre cuando la vista maneja validación, llamadas a terceros, lógica de negocio compleja y respuestas. Esto rompe el <strong>Principio de Responsabilidad Única (SRP)</strong>.</p>
                <div class="not-prose relative">
                    <div class="absolute top-0 right-0 p-2 text-xs text-red-400 font-bold">ANTI-PATRÓN</div>
                    <pre><code class="language-python"># Mal ejemplo: Toda la lógica en la vista
def comprar_curso(request, curso_id):
    curso = Curso.objects.get(id=curso_id)
    # Lógica de negocio mezclada con HTTP
    if request.user.saldo < curso.precio:
        return JsonResponse({'error': 'Saldo insuficiente'}, status=400)

    # Side effects directos
    request.user.saldo -= curso.precio
    request.user.save()
    send_email_confirmacion(request.user) # Bloquea el request

    return JsonResponse({'status': 'ok'})</code></pre>
                </div>

                <h3 id="fat-models-modelos-obesos">Fat Models (Modelos Obesos)</h3>
                <p>La reacción común a las Fat Views es mover la lógica al modelo (<code>model.comprar_curso()</code>). Aunque mejor, esto trae problemas graves:</p>
                <ul>
                    <li><strong>Exceso de Responsabilidad:</strong> El modelo sabe validar, guardar, enviar emails y calcular impuestos.</li>
                    <li><strong>Dificultad de Testeo:</strong> Para probar la lógica, necesitas instanciar el modelo y a menudo golpear la base de datos.</li>
                    <li><strong>Acoplamiento:</strong> Es difícil reutilizar esa lógica si mañana necesitas una API REST o una tarea asíncrona que no opera sobre una instancia HTTP.</li>
                </ul>

                <h2 id="3-capa-de-servicios-service-layer">3. Capa de Servicios (Service Layer)</h2>
                <p>La solución estándar en Django moderno es introducir una <strong>Capa de Servicios</strong>. Un servicio es una función o clase que encapsula una <strong>operación de negocio</strong> (Caso de Uso).</p>

                <p><strong>Reglas de Oro:</strong></p>
                <ol>
                    <li>La capa de servicios <strong>puede</strong> depender del ORM y modelos.</li>
                    <li>La capa de servicios <strong>NUNCA</strong> debe depender de <code>request</code>, <code>forms</code>, <code>serializers</code> o Vistas.</li>
                    <li>Debe manejar transacciones atómicas explícitamente.</li>
                </ol>

                <div class="not-prose">
                    <pre><code class="language-python"># services/cursos.py
from django.db import transaction
from .models import Curso, Inscripcion
from .tasks import send_email_async

def inscribir_estudiante(*, estudiante, curso_slug: str) -> Inscripcion:
    """
    Servicio puro: No sabe nada de HTTP. Recibe entidades de dominio o tipos primitivos.
    """
    with transaction.atomic():
        curso = Curso.objects.select_for_update().get(slug=curso_slug)

        if not estudiante.tiene_saldo(curso.precio):
            raise ValueError("Saldo insuficiente")

        inscripcion = Inscripcion.objects.create(estudiante=estudiante, curso=curso)
        estudiante.descontar_saldo(curso.precio)

        # Side-effect movido a tarea asíncrona
        transaction.on_commit(lambda: send_email_async.delay(estudiante.id))

    return inscripcion</code></pre>
                </div>
                <p>Esto permite que la misma lógica sea usada desde una View de Django, una API de DRF, una tarea de Celery o la consola de comandos sin duplicar código.</p>

                <h2 id="4-selectores-query-layer">4. Selectores (Query Layer)</h2>
                <p>Igual que separamos la lógica de escritura (Servicios), debemos separar la lógica de lectura compleja. Los <strong>Selectores</strong> son funciones encargadas de hacer queries optimizadas.</p>

                <p><strong>Beneficios:</strong></p>
                <ul>
                    <li>Centralizan optimizaciones como <code>select_related</code> y <code>prefetch_related</code>.</li>
                    <li>Evitan filtrar datos en las vistas.</li>
                    <li>Permiten cambiar la estructura de la DB sin romper las vistas (solo actualizas el selector).</li>
                </ul>

                <pre><code class="language-python"># selectors/cursos.py
def get_cursos_destacados() -> list[dict]:
    """
    Retorna una estructura de datos lista para consumir, desacoplando
    la vista del modelo interno.
    """
    return Curso.objects.filter(
        activo=True,
        destacado=True
    ).select_related('instructor').only('titulo', 'slug', 'precio', 'instructor__nombre')
</code></pre>

                <h2 id="5-arquitectura-limpia-y-ddd-pragmatico">5. Arquitectura Limpia, Hexagonal y DDD Pragmático</h2>

                <h3 id="5-1-el-problema-de-la-pureza">5.1 Por qué la "Clean Architecture pura" falla en Django</h3>
                <p>Intentar aplicar Clean Architecture "de libro" (desacoplar totalmente el ORM del dominio) en Django suele ser contraproducente. Django asume que el Modelo es el centro. Si ocultas los modelos detrás de repositorios genéricos, pierdes:</p>
                <ul>
                    <li>Django Admin</li>
                    <li>ModelForms y Validaciones automáticas</li>
                    <li>Optimizaciones del ORM (lazy loading, filtering)</li>
                    <li>Ecosistema de terceros (DRF, Filters, etc.)</li>
                </ul>

                <h3 id="5-2-ddd-pragmatico">5.2 DDD Pragmático</h3>
                <p>En su lugar, aplicamos un DDD pragmático:</p>
                <ul>
                    <li><strong>Bounded Contexts:</strong> Usamos las Django Apps para definir límites claros del dominio.</li>
                    <li><strong>Entities:</strong> Los <code>models.Model</code> actúan como entidades. No creamos clases "espejo" innecesarias.</li>
                    <li><strong>Value Objects:</strong> Usamos <code>dataclasses</code> para estructuras inmutables complejas que no requieren identidad de DB.</li>
                    <li><strong>Interfaces/Adaptadores:</strong> Abstraemos solo lo que está fuera de nuestro control (APIs de pagos, almacenamiento en S3, servicios de email), no la base de datos local.</li>
                </ul>

                <h2 id="6-monolito-modular">6. Monolito Modular: El punto óptimo</h2>
                <p>Antes de saltar a microservicios, la arquitectura ideal para el 95% de los proyectos Django es el <strong>Monolito Modular</strong>.</p>

                <h3 id="reglas-del-monolito-modular">Reglas estrictas:</h3>
                <ol>
                    <li><strong>Alta Cohesión:</strong> Cada App encapsula un dominio (ej: <code>billing</code>, <code>lms</code>, <code>users</code>).</li>
                    <li><strong>Bajo Acoplamiento:</strong> Una App NO debe importar modelos de otra App directamente para escribir datos. Debe usar la <strong>API Pública</strong> (Servicios) de la otra App.</li>
                    <li><strong>Infraestructura Compartida:</strong> La autenticación y configuración base son transversales.</li>
                </ol>

                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg my-4 border-l-4 border-green-500">
                    <h4 class="font-bold text-green-700 dark:text-green-400">Ejemplo de Configuración Modular</h4>
                    <p class="text-sm">Para soportar esta modularidad desde la infraestructura, abandonamos el <code>settings.py</code> único:</p>
                    <pre><code class="language-text">settings/
├── base.py       # Configuración común
├── local.py      # Dev: Debug=True, ConsoleEmailBackend
└── production.py # Prod: S3, Sentry, Redis, PostgreSQL strict</code></pre>
                </div>

                <h2 id="7-rendimiento-y-escalabilidad">7. Rendimiento y Escalabilidad Avanzada</h2>

                <h3 id="7-1-cqrs-pragmatico">7.1 CQRS (Command Query Responsibility Segregation)</h3>
                <p>Separamos los modelos de escritura (altamente normalizados) de los de lectura. Para reportes pesados, podemos tener tablas desnormalizadas o vistas materializadas que se actualizan vía señales o tareas en segundo plano.</p>

                <h3 id="7-2-caching-estrategico">7.2 Caching Estratégico (Redis)</h3>
                <p>No caches todo. Usa patrones:</p>
                <ul>
                    <li><strong>Cache-aside:</strong> La aplicación busca en cache, si falla busca en DB y guarda en cache.</li>
                    <li><strong>Russian Doll Caching:</strong> Cachear fragmentos de templates anidados.</li>
                    <li><strong>Invalidación:</strong> El problema más difícil. Prefiere tiempos de expiración cortos (TTL) a invalidación manual compleja.</li>
                </ul>

                <h3 id="7-3-indexing-query-optimization">7.3 Indexing y Query Optimization</h3>
                <p>El rendimiento de la base de datos suele ser el primer cuello de botella. Estrategias clave:</p>
                <ul>
                    <li><strong>Índices Compuestos:</strong> No basta con indexar campos individuales. Si filtras por <code>status</code> y ordenas por <code>created_at</code>, necesitas un <code>Index(['status', 'created_at'])</code>.</li>
                    <li><strong>Select Related & Prefetch Related:</strong> Usa <code>select_related</code> para FKs (JOINs) y <code>prefetch_related</code> para M2M (query adicional) para evitar el problema N+1.</li>
                    <li><strong>Defer & Only:</strong> No traigas columnas pesadas (Text, Blob) si no las vas a usar.</li>
                </ul>
                <div class="not-prose relative">
                   <div class="absolute top-0 right-0 p-2 text-xs text-green-600 font-bold">OPTIMIZADO</div>
                   <pre><code class="language-python"># Evitando N+1 Queries en DRF
queryset = Curso.objects.select_related('categoria', 'instructor') \
                        .prefetch_related('estudiantes') \
                        .only('id', 'titulo', 'categoria__nombre', 'instructor__nombre')</code></pre>
                </div>

                <h3 id="7-4-tareas-asincronas">7.4 Tareas Asíncronas (Celery/RQ)</h3>
                <p><strong>Regla:</strong> El ciclo Request-Response HTTP debe ser menor a 200ms. Todo lo que tarde más (enviar emails, procesar imágenes, reportes, pagos) debe ir a una cola (Queue).</p>

                <h2 id="8-integracion-con-microservicios">8. Integración con Microservicios</h2>
                <p>Solo divide el monolito cuando:</p>
                <ol>
                    <li>Una parte del dominio requiere escalar de forma independiente (ej: procesamiento de video intensivo).</li>
                    <li>Necesitas tecnología distinta (ej: un servicio de IA en Python/FastAPI vs Core en Django).</li>
                    <li>Equipos organizacionales distintos (Ley de Conway).</li>
                </ol>
                <p>En este caso, Django puede actuar como el orquestador o "Backend for Frontend" (BFF), comunicándose vía REST o gRPC con servicios especializados.</p>

                <h2 id="9-testing-estrategico">9. Testing Estratégico</h2>
                <p>Con la arquitectura de servicios, el testing se simplifica:</p>
                <ul>
                    <li><strong>Tests de Servicios:</strong> Son el núcleo. Prueban la lógica de negocio pura. Mockeran llamadas externas pero usan la DB real (Django test DB es rápida).</li>
                    <li><strong>Tests de Selectores:</strong> Verifican que las queries traigan los datos correctos.</li>
                    <li><strong>Tests de Vistas (End-to-End):</strong> Se reducen a verificar que la vista llame al servicio correcto y retorne el status code adecuado (Happy Path + Error Handling básico).</li>
                </ul>

                <h2 id="10-migraciones-evolucion-y-mantenimiento">10. Migraciones y Mantenimiento</h2>

                <h3 id="custom-user-model">El Modelo de Usuario Personalizado</h3>
                <p>Parte vital del mantenimiento a largo plazo es iniciar siempre con un <code>AUTH_USER_MODEL</code> personalizado (heredando de <code>AbstractUser</code>). Esto permite evolucionar la identidad del usuario (añadir UUIDs, cambiar email por username) sin romper las ForeignKeys de todo el sistema en el futuro.</p>

                <h3 id="rolling-updates">Rolling Updates</h3>
                <p>Para sistemas de alta disponibilidad, las migraciones de base de datos no deben romper el código anterior.
                Estrategia: 1. Añadir columna nueva (nullable). 2. Desplegar código que escribe en ambas. 3. Migrar datos antiguos. 4. Desplegar código que solo usa la nueva. 5. Borrar columna vieja.</p>

                <h2 id="11-conclusion-estrategica">11. Conclusión Estratégica</h2>
                <p>La arquitectura no es un destino, es una serie de decisiones de compromiso (trade-offs).</p>

                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th class="px-6 py-3">Escenario</th>
                                <th class="px-6 py-3">Arquitectura Recomendada</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">MVP / Prototipo</td>
                                <td class="px-6 py-4">Django Vainilla (MTV puro + Fat Models moderados).</td>
                            </tr>
                            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">Producto en Crecimiento</td>
                                <td class="px-6 py-4">Capas de Servicios y Selectores + Monolito Modular.</td>
                            </tr>
                            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">Escala Masiva / Equipos Múltiples</td>
                                <td class="px-6 py-4">Monolito Modular estricto + Microservicios satélite para tareas intensivas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <p class="mt-4 font-bold text-gray-900 dark:text-gray-100">
                    Premisa final: La arquitectura correcta es la mínima que elimina el dolor presente sin introducir complejidad innecesaria.
                </p>

            </main>

            <footer class="mt-12 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
                <p>&copy; 2024 Guía Definitiva de Django. Código validado y moderno.</p>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
</body>
</html>